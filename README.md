# Single Node CoreOS and Kubernetes Install

[CoreOS](https://coreos.com/) is the Host System we are using for the kubernetes installation. Since we are using CoreOS on a single-node (right now), in the following, you can find a description on how to setup a CoreOS single-node cluster. We are using a KVM-Base at [netcup](https://www.netcup.de/), but any other Hoster should work fine as well.

In the following, I am trying to re-play, what I did and provide some links and useful information on how to make this one work.

## Install CoreOS

Most of the following was taken from [The Hyperpessimist](https://xivilization.net/~marek/blog/2014/08/04/installing-coreos/). I chose the usual Ubuntu-Iso (note, use the ISO and do not install the image), which is offered by netcup as a base to be able to install coreos.

Before starting the installation, the discovery token for etcd2 should get generated by issuing the command:

``
curl https://discovery.etcd.io/new?size=1
``

The result of this call should be put into the cloud-config.yml in the property discovery.

The following should then be done using the VNC-console, since we are using the Live-CD to install core-os on the drive (/dev/sda at netcup). Use `System Rescue CD 4.2.0` at netcup (use Options: E (altker64 with more choices) --> 2. (all files cached to memory))

``
wget https://raw.github.com/coreos/init/master/bin/coreos-install
``

To install CoreOS in a "non-cloud" environment like netcup, you do need to provide an adopted cloud-config. This cloud-config file contains the public SSH-key, so that you are able to access the server using SSH with a key. Be sure to generate this key and put the public part of it into the `ssh-authorized-keys` section of the cloud-config file.  To be able to use this config-file, you do need to upload it to a server, where you can fetch this file via a wget, so that coreos can use it. If you don't know how to generate an SSH-key take a look into the [github help](https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/). An example can be found in the repository [devopskube-single-node](https://www.github.com/devopskube/devopskube-single-node/).

In the cloud-config file you will furthermore find the public IP of the server, this needs to get adopted as well. Right now it is defined as 192.168.0.1, which will not get routed to the internet. This file then needs to get copied to the instance, where you do like to install the coreos system. I put my personal file into my blog, where I can reach it during the further installation procedure via wget:

Afterwards the CoreOS installer can be called using the following commands:

``
chmod u+x coreos-install
bash coreos-install -d /dev/vda -C alpha -c cloud-config.yml
``

After the above described install, which can take some time, the system can be rebooted (please make sure, that the CD Rom is detached). The system is then reachable via the configured IP and the configured SSH-key.

>NOTE: You will not be able to login to your system by password, just via the given SSH-key

## Install kubernetes

To install kubernetes on a single-node, I followed the [CoreOS - Single-Node Kubernetes Installation](https://coreos.com/kubernetes/docs/latest/kubernetes-on-vagrant-single.html). This installation description is mainly for vagrant, but since we do have a single-node install as well, this fits quite nicely.

### Prepare Installation

Before we do setup kubernetes, we do need some SSL certificates. This can be done using the scripts in the repository mentioned in the above description [CoreOS - Single-Node Repository (scripts)](https://github.com/coreos/coreos-kubernetes/tree/master/lib). All of this should happen on the local machine.

>NOTE: All the required scripts can be copied from the above mentioned repository (eg. wget https://raw.githubusercontent.com/coreos/coreos-kubernetes/master/lib/init-ssl and wget https://raw.githubusercontent.com/coreos/coreos-kubernetes/master/lib/init-ssl-ca), do note, that we do not take any responsibilites for those.

The IP.1 should be the Public IP of the CoreOS host (eg. 8.8.8.8), the IP.2 should be the Internal IP of the CoreOS host, which is defined in the Cloud-Config-file above.

``
./init-ssl-ca ssl
./init-ssl ssl apiserver controller IP.1=<PUBLIC_IP_HOST>,IP.2=10.3.0.1,IP.3=172.17.42.1
./init-ssl ssl admin kube-admin
``

The generated files are then copied to the CoreOS host:

``
scp -r ssl core@<PUBLIC_IP_HOST>:/home/core
``

Then on the remote machine (CoreOS host), those files need to get moved to the correct location:

``
sudo mkdir -p /etc/kubernetes/ssl
sudo tar -C /etc/kubernetes/ssl -xf ssl/controller.tar
``

### Start Installation

To start the installation, the user_data from the [CoreOS-repository](https://raw.github.com/coreos/coreos-kubernetes/master/single-node/user-data) has to be adopted and copied to the remote host. Afterwards it can get executed and the install is basically done.

>NOTE: This file is adopted in some points, the adopted points are documented below.

``
# Advertised IP of the master (cluster IP that is)
export ADVERTISE_IP=172.17.41.1

# External IP of the master
export EXTERNAL_IP=<YOUR_IP>

# Port to open the API on to the external
export EXTERNAL_SSL_PORT=444
``

Furthermore, to be able to provide SSL via kube-lego for our own services, we do need to change the ssl port in the section `kube-apiserver`. There the `hostPort` should be changed from 443 to 444. All of this is already done in the corresponding user-data in this repository.

>NOTE: This file is copied form the mentioned remote repository as well. The used version is for Kubernetes 1.4.3, and there could be changes in this file for future versions.

Äˆopy the user data to the remote host:

``
scp user_data core@<PUBLIC_IP_HOST>:/home/core
``

Move the User-Data and the ssl-key on the remote host to the correct location and execute the install script (user_data):

``
sudo mkdir -p /etc/kubernetes/ssl
sudo cp /home/core/ssl/ca.pem /etc/kubernetes/ssl
sudo cp /home/core/ssl/apiserver.pem /etc/kubernetes/ssl
sudo cp /home/core/ssl/apiserver-key.pem /etc/kubernetes/ssl

sudo mkdir -p /var/lib/coreos-kubernetes
sudo cp /home/core/user_data /var/lib/coreos-kubernetes/user_data
sudo chmod u+x /var/lib/coreos-kubernetes/user_data
sudo /var/lib/coreos-kubernetes/user_data
``


### Execute kubectl

To be able to execute kubectl on your local machine, you have to provide a valid kubeconfig. There is
one in this repository, but it needs to get adopted. Afterwards, you are able to use the following
commands:

``
export KUBECONFIG="${KUBECONFIG}:$(pwd)/kubeconfig"
kubectl config use-context netcup
``

### Add useful pods

#### Pre-Requisite (SSL-Login-Certificate)

To be able to login to the following pods, k18s expects you to have an certificate. This can be
generated using the already created ssl-certificates:

``
openssl pkcs12 -export -in ./ssl/admin.pem -inkey ./ssl/admin-key.pem -out ./ssl/admin.p12
``

Afterwards you have to import the generated file into chromium using the used password.

Then you can modify your kubeconfig and connect via kubectl via:

``
export KUBECONFIG=$(pwd)/kubeconfig.private
kubectl config use-context netcup
``

#### Kubernetes Dashboard (Management)

We are going to add the [Kubernetes Dashboard](https://github.com/kubernetes/dashboard) the following two
commands should be executed, so that the Administration is helped by a nice web-ui.

``
kubectl create -f https://rawgit.com/kubernetes/dashboard/master/src/deploy/kubernetes-dashboard.yaml
``

Afterwards the Dashboad can be reached on the URL:

``
https://<PUBLIC_IP_HOST>/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard/#/replicationcontrollers
``

Please note, that to be able to login to the above mentioned dashboard, the Certificate should be
imported in Chrome.

#### Kubernetes Dash (Monitoring)

To show the Monitoring information, the [Kubernetes Dash](https://github.com/kubernetes/kubedash) should
be installed using the following command:

``
kubectl create -f addon/kubedash-config.yaml
``

Afterwards the Monitoring can be reached via the following URL:

``
https://<PUBLIC_IP_HOST>/api/v1/proxy/namespaces/kube-system/services/kubedash/#!/
``

Please note, that to be able to login to the above mentioned dash, the Certificate should be
imported in Chrome.

## TODO

[] Add email possibility for Redmine
[] Make Redmine and other containers SSL-aware
[] Ingress needs 443, blocked by kube-apiserver (/etc/kubernetes/manifests/kube-apiserver.yaml), use port 444 in there and restart kubelet service
